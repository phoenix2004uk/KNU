FUNCTION FnError{PARAMETER m,n IS 0.RETURN Lexicon("error",m,"errno",-ABS(n)).}FUNCTION FnSuccess{PARAMETER m IS 1,n IS 1.RETURN Lexicon("value",m,"errno",ABS(n)).}FUNCTION IsError{PARAMETER x.RETURN x:IsType("Lexicon") AND x["errno"]<1.}FUNCTION IsSuccess{PARAMETER x.RETURN x:IsType("Lexicon") AND x["errno"]>0.}FUNCTION OnError{PARAMETER x,f.IF IsError(x)f(x).RETURN x.}FUNCTION OnSuccess{PARAMETER x,f.IF IsSuccess(x)f(x).RETURN x.}FUNCTION OnResult{PARAMETER x,t,f.OnError(x,f).OnSuccess(x,t).RETURN x.}FUNCTION KnuPanic{PARAMETER m.HUDTEXT("PANIC! "+m,5,2,30,RED,TRUE).WAIT 60.REBOOT.}FUNCTION HasKSCConnection{IF ADDONS:AVAILABLE("RT") RETURN ADDONS:RT:HasKSCConnection(SHIP).ELSE RETURN HOMECONNECTION:ISCONNECTED AND HOMECONNECTION:DESTINATION="HOME".}OnResult(({GLOBAL ERR_DL_CON IS -4.GLOBAL ERR_DL_404 IS -3.GLOBAL ERR_DL_SIZE IS -2.GLOBAL ERR_DL_EXIST IS -1.LOCAL Z IS FnSuccess. IF ADDONS:AVAILABLE("RT")SET Z TO{PARAMETER A.LOCAL B IS TIME:SECONDS. UNTIL TIME:SECONDS-B>2.4/2048*A+ADDONS:RT:KSCDELAY(SHIP){IF NOT HasKSCConnection()RETURN FnError("Transfer interupted",ERR_DL_CON).WAIT 0.1.}RETURN FnSuccess().}.GLOBAL GetKSCFile IS{PARAMETER A,B IS A,D IS 0.IF(NOT D)AND EXISTS(B)RETURN FnError("Destination file exists: "+B,ERR_DL_EXIST).IF NOT HasKSCConnection()RETURN FnError("No connection to KSC",ERR_DL_CON).LOCAL F IS VOLUME(0):OPEN(A).IF F:ISTYPE("Boolean")RETURN FnError("File not found: "+A,ERR_DL_404).LOCAL H IS VOLUME(1):FREESPACE. LOCAL J IS F:SIZE. IF H<J RETURN FnError("Insufficient free space: "+A+" ("+J+") > 1:("+H+")",ERR_DL_SIZE).LOCAL K IS Z(J).IF IsError(K)RETURN K. COPYPATH("0:"+A,"1:"+B).RETURN FnSuccess(B).}.GLOBAL UpdateBootstrap IS{KnuPanic("Not implemented").}.GLOBAL UpdateLoader IS{KnuPanic("Not implemented").}.GLOBAL GetLatestVersion IS{PARAMETER A,B,D IS 0,F IS 0.LOCAL H IS VOLUME(F):OPEN(B):LIST:VALUES:REVERSEITERATOR. LOCAL J IS "^"+A+"(-v[0-9]+(\.[0-9]+){0,3}){0,1}".IF D SET J TO J+"\.min".UNTIL NOT H:NEXT IF H:VALUE:NAME:MATCHESPATTERN(J+"\.ks$")RETURN FnSuccess(H:VALUE).RETURN FnError(A+" not found in "+B,ERR_DL_404).}.IF NOT EXISTS("/boot/knuldr"){IF SHIP:STATUS <> "PRELAUNCH"{PRINT "WARNING! KNULDR is missing".PRINT "Press Y to REBOOT, or N to wait for a KSC connection to download a new loader".UNTIL 0{LOCAL A IS TERMINAL:INPUT:GETCHAR(). IF A="y" REBOOT. IF A="n" BREAK.}UNTIL HasKSCConnection()WAIT 60.}ELSE IF NOT HasKSCConnection()RETURN FnError("No connection to KSC").LOCAL B IS GetLatestVersion("knuldr","knulib").IF IsError(B)RETURN FnError("KNULDR not found at KSC").SET B TO GetKSCFile("knulib/"+B["value"],"boot/knuldr").IF IsSuccess(B)REBOOT. RETURN B.}RETURN FnSuccess().}):call,{PARAMETER x.RUNPATH("/boot/knuldr").},{PARAMETER x.KnuPanic(x["error"]).}).