{IF NOT EXISTS("/etc/callsign"){LOCAL A IS SHIP:NAME. LOCAL B IS A. LOCAL D IS A. LOCAL F IS A. LOCAL H IS A:LENGTH. LOCAL J IS A:FIND("-").IF A:MATCHESPATTERN("^[A-Z]+-[0-9]+[a-zA-Z_]{0,1}$"){SET B TO A. SET D TO A. SET F TO A:SUBSTRING(0,J).}ELSE IF A:MATCHESPATTERN("^[A-Z]+ - [A-Z0-9 _]+$"){SET B TO A:SUBSTRING(J+2, H-J-2).SET D TO A. SET F TO A:SUBSTRING(0,J-1).}ELSE IF A:MATCHESPATTERN("^[A-Z]+-[0-9]+ ("+char(34)+"|')[A-Za-z0-9 _]+("+char(34)+"|')$"){LOCAL K IS A:FIND(" ").SET B TO A:SUBSTRING(K+2,H-K-1).SET D TO A:SUBSTRING(0,K).SET F TO A:SUBSTRING(0,J).}SET SHIP:NAME TO B. Write("/etc/callsign",B).Write("/etc/class",D).Write("/etc/mission",F).}DELETEPATH("1:/mission/").IF NOT HasKSCConnection()KnuPanic("No connection to KSC").LOCAL A IS GetCallsign().LOCAL B IS GetShipClass().LOCAL D IS GetMissionTag().LOCAL F IS 0.FOR H IN List(A+".ks",A+"/main.ks",D+"/"+A+".ks",D+"/"+A+"/main.ks",B+".ks",B+"/main.ks",D+"/"+B+".ks",D+"/"+B+"/main.ks",D+".ks",D+"/main.ks","main.ks")IF EXISTS("0:/missions/"+H){SET F TO"0:/missions/"+H. BREAK.}IF F{LOCAL J IS path(F).LOCAL K IS ""+J:PARENT. LOCAL L IS J:NAME:REPLACE(".ks","").LOCAL N IS OPEN(K):LIST:VALUES:ITERATOR. UNTIL NOT N:NEXT{LOCAL O IS N:VALUE. IF O:NAME:MATCHESPATTERN("^"+L+"(\.[^\.]+){0,1}\.ks$"){LOCAL P IS O:NAME:REPLACE(L,"main").IF NOT download(O:NAME,K:SUBSTRING(2,K:LENGTH-2))KnuPanic(O:NAME,"download").MOVEPATH("1:/home/"+O:NAME,"1:/mission/"+P).}}}ELSE PRINT "no mission available".export(Lex("version","1.0.5")).}